{% extends "tabbed.html" %}

{% block head %}
<title>BUSCO Detailed View</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet" />
<script type="text/javascript">
  // temporary hack to make it look good with Bootstrap 5
  removeBS3refs();
</script>
<script src="https://cdn.jsdelivr.net/npm//vega@5" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-lite@5.16.3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-embed@6" type="text/javascript"></script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block tabcontent %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<div class="row">
  <div class="col-12">
    <div class="card mt-3 h-10">
      <h5 class="card-header">Plot controls</h5>
      <div class="card-body">
        <p>
        The plot below shows all MAGs in a single view. You can hover over the bars to obtain information 
        about the lineage dataset used for each MAG, and the number of genes in each BUSCO category. 
        You can choose the assembly statistic that you wish to display from the dropdown menu below.
        </p>
        <div id="plot-controls">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center">
              <label for="metricSelector" class="form-label mb-0 me-2">Assembly metric:</label>
              <select id="metricSelector" class="form-select form-select-sm" style="width: auto;">
                <option value="contigs_n50">Contig N50</option>
                <option value="percent_gaps">Percent gaps</option>
                <option value="scaffolds">Number of scaffolds</option>
              </select>
            </div>
            <div class="d-flex align-items-center gap-2 ms-3">
              <span class="text-muted small">BUSCO categories:</span>
              <div class="d-flex align-items-center gap-2">
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #4A90A4; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Single</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #F5A623; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Duplicated</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #D2691E; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Fragmented</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #A0522D; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Missing</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card">
      <h5 class="card-header">BUSCO Results and Assembly Statistics</h5>
      <div class="card-body">
        <div id="combinedPlotContainer" class="plot-container">Loading plots...</div>
      </div>
    </div>
  </div>
</div>

<!-- Combined Vega Spec -->
<script id="vega_combined_detailed_spec" type="application/json">
  {{ vega_combined_detailed_spec | safe }}
</script>

<!-- Data -->
<script id="detailed_data" type="application/json">
  {{ detailed_data | safe }}
</script>

<script id="assembly_data" type="application/json">
  {{ assembly_data | safe }}
</script>

<script id="mag_ids_sorted" type="application/json">
  {{ mag_ids_sorted | safe }}
</script>

<script id="assembly_metrics_json" type="application/json">
  {{ assembly_metrics_json | safe }}
</script>

<script type="text/javascript">
  // Store plot view for updates
  window.plotView = null;

  // Load data once
  let detailedData, assemblyData, magIdsSorted, assemblyMetrics;
  let combinedSpec;

  function updatePlot() {
    const metricSelector = document.getElementById('metricSelector');
    const selectedMetric = metricSelector ? metricSelector.value : 'contigs_n50';
    const metricTitle = assemblyMetrics[selectedMetric] || selectedMetric;
    const plotContainer = document.getElementById('combinedPlotContainer');
    
    if (!plotContainer) return;
    
    // Clear existing plot
    plotContainer.innerHTML = '';
    
    // Create combined plot spec
    const plotSpec = JSON.parse(JSON.stringify(combinedSpec));
    
    // Calculate widths based on container
    // Account for padding, margins, y-axis labels (~100px), and spacing
    const containerWidth = plotContainer.offsetWidth || plotContainer.clientWidth || 800;
    const yAxisLabelWidth = 120;  // Space for MAG ID labels (feature data shows full labels)
    const spacing = plotSpec.spacing || 5;
    const assemblyPlotWidth = 150;  // Fixed width for assembly plot
    const availableWidth = containerWidth - yAxisLabelWidth - spacing - 40;  // 40px for padding
    const buscoPlotWidth = Math.max(300, availableWidth - assemblyPlotWidth);
    
    // Set explicit widths
    plotSpec.hconcat[0].width = buscoPlotWidth;
    plotSpec.hconcat[1].width = assemblyPlotWidth;
    
    // Set parameters - show labels for feature data
    plotSpec.params[1].value = true;  // show_labels = true for feature data
    plotSpec.params[2].value = selectedMetric;  // metric_field
    plotSpec.params[3].value = metricTitle;  // metric_title
    
    // Inject data into both hconcat children
    plotSpec.hconcat[0].data = { values: detailedData };
    plotSpec.hconcat[1].data = { values: assemblyData };
    
    // Set the x-axis title for assembly plot
    if (plotSpec.hconcat[1].encoding && plotSpec.hconcat[1].encoding.x) {
      plotSpec.hconcat[1].encoding.x.title = metricTitle;
    }
    
    // Set y-axis sort order for both plots
    if (plotSpec.hconcat[0].encoding && plotSpec.hconcat[0].encoding.y) {
      plotSpec.hconcat[0].encoding.y.sort = magIdsSorted;
    }
    if (plotSpec.hconcat[1].encoding && plotSpec.hconcat[1].encoding.y) {
      plotSpec.hconcat[1].encoding.y.sort = magIdsSorted;
    }
    
    // Add autosize configuration
    plotSpec.autosize = { type: "fit", contains: "padding" };
    
    vegaEmbed(plotContainer, plotSpec, {
      actions: false,
      renderer: 'svg'
    }).then(
      function (result) {
        result.view.logLevel(vega.Warn);
        window.plotView = result.view;
      }
    ).catch(
      function (error) {
        plotContainer.innerHTML = `
          <div class="alert alert-warning">
            <strong>Error loading plots:</strong> ${error.message}
          </div>
        `;
      }
    );
  }

  $(document).ready(function () {
    // temporary hack to make it look good with Bootstrap 5
    adjustTagsToBS3()

    // Load specs and data
    combinedSpec = JSON.parse(document.getElementById('vega_combined_detailed_spec').textContent);
    detailedData = JSON.parse(document.getElementById('detailed_data').textContent);
    assemblyData = JSON.parse(document.getElementById('assembly_data').textContent);
    magIdsSorted = JSON.parse(document.getElementById('mag_ids_sorted').textContent);
    assemblyMetrics = JSON.parse(document.getElementById('assembly_metrics_json').textContent);

    // Add event listener for metric selector
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
      metricSelector.addEventListener('change', updatePlot);
    }
    
    // Add resize handler to re-render plot when window is resized
    let resizeTimeout;
    window.addEventListener('resize', function() {
      // Debounce to avoid too many re-renders
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        updatePlot();
      }, 50);  // Wait 250ms after resize stops before re-rendering
    });
    
    // Initial plot render
    updatePlot();
  });
</script>

{% endblock %}

{% block footer %}
<script type="text/javascript">
  // Simple error handler function
  function handleErrors(errors, element) {
    console.error('Vega/Vega-Lite error:', errors);
    if (element && element.length) {
      element.html('<div class="alert alert-danger"><strong>Error:</strong> Failed to render plot. Check console for details.</div>');
    }
  }
</script>
{% endblock %}
