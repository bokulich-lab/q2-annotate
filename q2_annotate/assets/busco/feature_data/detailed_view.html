{% extends "tabbed.html" %}

{% block head %}
<title>BUSCO Detailed View</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet" />
<script type="text/javascript">
  // temporary hack to make it look good with Bootstrap 5
  removeBS3refs();
</script>
<script src="https://cdn.jsdelivr.net/npm//vega@5" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-lite@5.16.3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-embed@6" type="text/javascript"></script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block tabcontent %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<div class="row mb-4 mt-2">
  <div class="col-lg-12">
    <div class="card">
      <h5 class="card-header">Plot controls</h5>
      <div class="card-body">
        <p>
        The plot below shows all MAGs in a single view. You can hover over the bars to obtain information 
        about the lineage dataset used for each MAG, and the number of genes in each BUSCO category. 
        You can choose the assembly statistic that you wish to display from the dropdown menu below.
        </p>
        <div id="plot-controls">
          <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
            <div class="d-flex align-items-center">
              <label for="metricSelector" class="form-label mb-0 me-2">Assembly metric:</label>
              <select id="metricSelector" class="form-select form-select-sm" style="width: auto;">
                <option value="contigs_n50">Contig N50</option>
                <option value="percent_gaps">Percent gaps</option>
                <option value="scaffolds">Number of scaffolds</option>
              </select>
            </div>
          </div>
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
              <span class="text-muted small">Sort by BUSCO:</span>
              <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="single" data-source="busco" title="Sort by Single (highest to lowest)">
                  <div class="busco-legend-color" style="background-color: #4A90A4; width: 14px; height: 14px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Single</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="duplicated" data-source="busco" title="Sort by Duplicated (highest to lowest)">
                  <div class="busco-legend-color" style="background-color: #F5A623; width: 14px; height: 14px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Duplicated</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="fragmented" data-source="busco" title="Sort by Fragmented (highest to lowest)">
                  <div class="busco-legend-color" style="background-color: #D2691E; width: 14px; height: 14px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Fragmented</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="missing" data-source="busco" title="Sort by Missing (highest to lowest)">
                  <div class="busco-legend-color" style="background-color: #A0522D; width: 14px; height: 14px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Missing</span>
                </button>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="text-muted small">Sort by assembly:</span>
              <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="contigs_n50" data-source="assembly" title="Sort by Contig N50 (highest to lowest)">
                  <span class="small">N50</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="percent_gaps" data-source="assembly" title="Sort by Percent Gaps (lowest to highest)">
                  <span class="small">Gaps</span>
                </button>
                <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="scaffolds" data-source="assembly" title="Sort by Scaffolds (lowest to highest)">
                  <span class="small">Scaffolds</span>
                </button>
              </div>
            </div>
            <button class="btn btn-sm btn-outline-secondary d-flex align-items-center sort-btn" data-sort="default" data-source="default" title="Reset to default order">
              <span class="small">Reset</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-0">
  <div class="col-8">
    <div id="buscoPlotContainer" class="plot-container">Loading BUSCO plot...</div>
  </div>
  <div class="col-4">
    <div id="assemblyPlotContainer" class="plot-container">Loading assembly plot...</div>
  </div>
</div>

<!-- Vega Specs -->
<script id="vega_busco_detailed_spec" type="application/json">
  {{ vega_busco_detailed_spec | safe }}
</script>

<script id="vega_assembly_detailed_spec" type="application/json">
  {{ vega_assembly_detailed_spec | safe }}
</script>

<!-- Data -->
<script id="detailed_data" type="application/json">
  {{ detailed_data | safe }}
</script>

<script id="assembly_data" type="application/json">
  {{ assembly_data | safe }}
</script>

<script id="mag_ids_sorted" type="application/json">
  {{ mag_ids_sorted | safe }}
</script>

<script id="assembly_metrics_json" type="application/json">
  {{ assembly_metrics_json | safe }}
</script>

<script type="text/javascript">
  // Load data once
  let detailedData, assemblyData, magIdsSorted, magIdsDefault, assemblyMetrics;
  let buscoSpec, assemblySpec;
  let currentSortCategory = 'default';
  let currentSortSource = 'default';

  function getSortedMagIds(category, source) {
    if (category === 'default' || source === 'default') {
      return [...magIdsDefault];
    }
    
    const valueMap = {};
    
    if (source === 'busco') {
      // Sort by BUSCO category (from detailedData)
      detailedData.forEach(d => {
        if (d.category === category) {
          valueMap[d.mag_id] = d.BUSCO_percentage || 0;
        }
      });
      // Higher is better for BUSCO metrics
      return [...magIdsDefault].sort((a, b) => {
        const valA = valueMap[a] || 0;
        const valB = valueMap[b] || 0;
        return valB - valA;  // Descending order
      });
    } else if (source === 'assembly') {
      // Sort by assembly metric (from assemblyData)
      assemblyData.forEach(d => {
        valueMap[d.mag_id] = d[category] || 0;
      });
      // For N50: higher is better, for gaps/scaffolds: lower is better
      const ascending = (category === 'percent_gaps' || category === 'scaffolds');
      return [...magIdsDefault].sort((a, b) => {
        const valA = valueMap[a] || 0;
        const valB = valueMap[b] || 0;
        return ascending ? (valA - valB) : (valB - valA);
      });
    }
    
    return [...magIdsDefault];
  }

  function updateSortButtons(activeCategory) {
    document.querySelectorAll('.sort-btn').forEach(btn => {
      if (btn.dataset.sort === activeCategory) {
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-primary');
      } else {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-secondary');
      }
    });
  }

  function updatePlots() {
    const metricSelector = document.getElementById('metricSelector');
    const selectedMetric = metricSelector ? metricSelector.value : 'contigs_n50';
    const metricTitle = assemblyMetrics[selectedMetric] || selectedMetric;
    
    const buscoContainer = document.getElementById('buscoPlotContainer');
    const assemblyContainer = document.getElementById('assemblyPlotContainer');
    
    if (!buscoContainer || !assemblyContainer) return;
    
    // Get sorted mag IDs based on current sort category and source
    magIdsSorted = getSortedMagIds(currentSortCategory, currentSortSource);
    
    // Create BUSCO plot spec
    const buscoPlotSpec = JSON.parse(JSON.stringify(buscoSpec));
    buscoPlotSpec.data = { values: detailedData };
    if (buscoPlotSpec.encoding && buscoPlotSpec.encoding.y) {
      buscoPlotSpec.encoding.y.sort = magIdsSorted;
    }
    
    // Create Assembly plot spec
    const assemblyPlotSpec = JSON.parse(JSON.stringify(assemblySpec));
    assemblyPlotSpec.params[1].value = selectedMetric;  // metric_field
    assemblyPlotSpec.params[2].value = metricTitle;  // metric_title
    assemblyPlotSpec.data = { values: assemblyData };
    if (assemblyPlotSpec.encoding && assemblyPlotSpec.encoding.x) {
      assemblyPlotSpec.encoding.x.title = metricTitle;
    }
    if (assemblyPlotSpec.encoding && assemblyPlotSpec.encoding.y) {
      assemblyPlotSpec.encoding.y.sort = magIdsSorted;
    }
    
    // Embed BUSCO plot
    vegaEmbed(buscoContainer, buscoPlotSpec, {
      actions: false,
      renderer: 'svg'
    }).then(result => {
      result.view.logLevel(vega.Warn);
    }).catch(error => {
      buscoContainer.innerHTML = `<div class="alert alert-warning">Error: ${error.message}</div>`;
    });
    
    // Embed Assembly plot
    vegaEmbed(assemblyContainer, assemblyPlotSpec, {
      actions: false,
      renderer: 'svg'
    }).then(result => {
      result.view.logLevel(vega.Warn);
    }).catch(error => {
      assemblyContainer.innerHTML = `<div class="alert alert-warning">Error: ${error.message}</div>`;
    });
  }

  $(document).ready(function () {
    // temporary hack to make it look good with Bootstrap 5
    adjustTagsToBS3()

    // Load specs and data
    buscoSpec = JSON.parse(document.getElementById('vega_busco_detailed_spec').textContent);
    assemblySpec = JSON.parse(document.getElementById('vega_assembly_detailed_spec').textContent);
    detailedData = JSON.parse(document.getElementById('detailed_data').textContent);
    assemblyData = JSON.parse(document.getElementById('assembly_data').textContent);
    magIdsDefault = JSON.parse(document.getElementById('mag_ids_sorted').textContent);
    magIdsSorted = [...magIdsDefault];
    assemblyMetrics = JSON.parse(document.getElementById('assembly_metrics_json').textContent);

    // Add event listener for metric selector
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
      metricSelector.addEventListener('change', updatePlots);
    }
    
    // Add event listeners for sort buttons
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        currentSortCategory = this.dataset.sort;
        currentSortSource = this.dataset.source || 'default';
        updateSortButtons(currentSortCategory);
        updatePlots();
      });
    });
    
    // Initial plot render
    updatePlots();
  });
</script>

{% endblock %}

{% block footer %}
<script type="text/javascript">
  // Simple error handler function
  function handleErrors(errors, element) {
    console.error('Vega/Vega-Lite error:', errors);
    if (element && element.length) {
      element.html('<div class="alert alert-danger"><strong>Error:</strong> Failed to render plot. Check console for details.</div>');
    }
  }
</script>
{% endblock %}
