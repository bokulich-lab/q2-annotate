{% extends "tabbed.html" %}

{% block head %}
<title>Embedding Vega-Lite</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet" />
<script type="text/javascript">
  // temporary hack to make it look good with Bootstrap 5
  removeBS3refs();
</script>
<script src="https://cdn.jsdelivr.net/npm//vega@5" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-lite@5.16.3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-embed@6" type="text/javascript"></script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block tabcontent %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<div class="row">
  <div class="col-12">
    <div class="card mt-3 h-10">
      <h5 class="card-header">Plot controls</h5>
      <div class="card-body">
        <p>
        The plot below shows all MAGs in a single view. You can hover over the bars to obtain information 
        about the lineage dataset used for each MAG, and the number of genes in each BUSCO category. 
        You can choose the assembly statistic that you wish to display from the dropdown menu below.
        </p>
        <div id="plot-controls">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center">
              <input type="checkbox" id="showAssemblyColumn" class="form-check-input me-2" checked>
              <label for="showAssemblyColumn" class="form-check-label mb-0 me-2">Show assembly statistics</label>
            </div>
            <div class="d-flex align-items-center">
              <label for="metricSelector" class="form-label mb-0 me-2">Assembly metric:</label>
              <select id="metricSelector" class="form-select form-select-sm" style="width: auto;">
                <option value="contigs_n50">Contig N50</option>
                <option value="percent_gaps">Percent gaps</option>
                <option value="scaffolds">Number of scaffolds</option>
              </select>
            </div>
            <div class="d-flex align-items-center gap-2 ms-3">
              <span class="text-muted small">BUSCO categories:</span>
              <div class="d-flex align-items-center gap-2">
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #4A90A4; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Single</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #F5A623; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Duplicated</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #D2691E; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Fragmented</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #A0522D; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Missing</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-8" id="buscoCol">
    <div class="card">
      <h5 class="card-header">BUSCO results</h5>
      <div class="card-body">
        <div id="buscoPlotContainer" class="plot-container"></div>
      </div>
    </div>
  </div>
  <div class="col-lg-4" id="assemblyCol">
    <div class="card">
      <h5 class="card-header">Assembly statistics</h5>
      <div class="card-body">
        <div id="assemblyPlotContainer" class="plot-container"></div>
      </div>
    </div>
  </div>
</div>

<script id="vega_detailed_json" type="application/json">
  {{ vega_detailed_plots | safe }}
</script>

<script type="text/javascript">
  // Store plot views for updates
  window.buscoPlotView = null;
  window.assemblyPlotView = null;

  function updatePlots() {
    const metricSelector = document.getElementById('metricSelector');
    const selectedMetric = metricSelector ? metricSelector.value : 'contigs_n50';
    const buscoContainer = document.getElementById('buscoPlotContainer');
    const assemblyContainer = document.getElementById('assemblyPlotContainer');
    
    if (!buscoContainer) return;
    
    // Get the plot specs
    const detailedSpecs = JSON.parse(document.getElementById('vega_detailed_json').textContent);
    const allMagsSpec = detailedSpecs['all_mags'];
    
    if (!allMagsSpec || !allMagsSpec.busco_plot) {
      buscoContainer.innerHTML = '<div class="alert alert-warning">No BUSCO plot available.</div>';
      return;
    }
    
    // Clear existing plots
    buscoContainer.innerHTML = '';
    if (assemblyContainer) {
      assemblyContainer.innerHTML = '';
    }
    
    // Get the plot specs (make copies to avoid modifying the original)
    const buscoSpec = JSON.parse(JSON.stringify(allMagsSpec.busco_plot));
    
    // Embed BUSCO plot
    vegaEmbed(buscoContainer, buscoSpec, {
      actions: false,
      renderer: 'svg'
    }).then(
      function (result) {
        result.view.logLevel(vega.Warn);
        window.buscoPlotView = result.view;
      }
    ).catch(
      function (error) {
        buscoContainer.innerHTML = `
          <div class="alert alert-warning">
            <strong>Error loading BUSCO plot:</strong> ${error.message}
          </div>
        `;
      }
    );
    
    // Embed assembly plot if available and column is visible
    const showAssemblyColumn = document.getElementById('showAssemblyColumn');
    const shouldShowAssembly = showAssemblyColumn && showAssemblyColumn.checked;
    
    if (shouldShowAssembly && assemblyContainer && allMagsSpec.assembly_plots && allMagsSpec.assembly_plots[selectedMetric]) {
      const assemblySpec = JSON.parse(JSON.stringify(allMagsSpec.assembly_plots[selectedMetric]));
      vegaEmbed(assemblyContainer, assemblySpec, {
        actions: false,
        renderer: 'svg'
      }).then(
        function (result) {
          result.view.logLevel(vega.Warn);
          window.assemblyPlotView = result.view;
        }
      ).catch(
        function (error) {
          assemblyContainer.innerHTML = `
            <div class="alert alert-warning">
              <strong>Error loading assembly plot:</strong> ${error.message}
            </div>
          `;
        }
      );
    }
  }

  function toggleAssemblyColumn() {
    const checkbox = document.getElementById('showAssemblyColumn');
    const assemblyCol = document.getElementById('assemblyCol');
    const buscoCol = document.getElementById('buscoCol');
    const metricSelector = document.getElementById('metricSelector');
    
    if (checkbox && assemblyCol && buscoCol) {
      if (checkbox.checked) {
        // Show assembly column
        assemblyCol.style.display = '';
        buscoCol.className = 'col-lg-8';
        if (metricSelector) {
          metricSelector.disabled = false;
        }
        // Update plots when showing the column
        updatePlots();
      } else {
        // Hide assembly column
        assemblyCol.style.display = 'none';
        buscoCol.className = 'col-lg-12';
        if (metricSelector) {
          metricSelector.disabled = true;
        }
        // Resize BUSCO plot to fit new container width
        setTimeout(function() {
          if (window.buscoPlotView) {
            const container = document.getElementById('buscoPlotContainer');
            if (container) {
              window.buscoPlotView.width(container.offsetWidth).run();
            }
          }
        }, 100);
      }
    }
  }

  $(document).ready(function () {
    // temporary hack to make it look good with Bootstrap 5
    adjustTagsToBS3()

    // Add event listener for metric selector
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
      metricSelector.addEventListener('change', updatePlots);
    }
    
    // Add event listener for assembly column checkbox
    const showAssemblyColumn = document.getElementById('showAssemblyColumn');
    if (showAssemblyColumn) {
      showAssemblyColumn.addEventListener('change', toggleAssemblyColumn);
      // Set default to checked
      showAssemblyColumn.checked = true;
    }
    
    // Initial plot render
    updatePlots();
  });
</script>

{% endblock %}

{% block footer %}
<script type="text/javascript">
  // Simple error handler function
  function handleErrors(errors, element) {
    console.error('Vega/Vega-Lite error:', errors);
    if (element && element.length) {
      element.html('<div class="alert alert-danger"><strong>Error:</strong> Failed to render plot. Check console for details.</div>');
    }
  }
</script>
{% endblock %}
