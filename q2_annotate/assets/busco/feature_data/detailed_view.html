{% extends "tabbed.html" %}

{% block head %}
<title>Embedding Vega-Lite</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet" />
<script type="text/javascript">
  // temporary hack to make it look good with Bootstrap 5
  removeBS3refs();
</script>
<script src="https://cdn.jsdelivr.net/npm//vega@5" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-lite@5.16.3" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-embed@6" type="text/javascript"></script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block tabcontent %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<div class="row">
  <div class="col-12">
    <div class="card mt-3 h-10">
      <h5 class="card-header">Plot controls</h5>
      <div class="card-body">
        <p>
        The plot below shows all MAGs in a single view. You can hover over the bars to obtain information 
        about the lineage dataset used for each MAG, and the number of genes in each BUSCO category. 
        You can choose the assembly statistic that you wish to display from the dropdown menu below.
        </p>
        <div id="plot-controls">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div class="d-flex align-items-center">
              <label for="metricSelector" class="form-label mb-0 me-2">Assembly metric:</label>
              <select id="metricSelector" class="form-select form-select-sm" style="width: auto;">
                <option value="contigs_n50">Contig N50</option>
                <option value="percent_gaps">Percent gaps</option>
                <option value="scaffolds">Number of scaffolds</option>
              </select>
            </div>
            <div class="d-flex align-items-center gap-2 ms-3">
              <span class="text-muted small">BUSCO categories:</span>
              <div class="d-flex align-items-center gap-2">
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #4A90A4; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Single</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #F5A623; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Duplicated</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #D2691E; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Fragmented</span>
                </div>
                <div class="d-flex align-items-center">
                  <div class="busco-legend-color" style="background-color: #A0522D; width: 16px; height: 16px; border-radius: 2px; margin-right: 4px;"></div>
                  <span class="small">Missing</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-12">
    <div id="plot">
      <div id="plotContainer" class="plot-container"></div>
    </div>
  </div>
</div>

<script id="vega_detailed_json" type="application/json">
  {{ vega_detailed_plots | safe }}
</script>

<script type="text/javascript">
  // Store plot view for metric updates
  window.plotView = null;

  function updatePlot() {
    const metricSelector = document.getElementById('metricSelector');
    const selectedMetric = metricSelector ? metricSelector.value : 'contigs_n50';
    const plotContainer = document.getElementById('plotContainer');
    
    if (!plotContainer) return;
    
    // Get the plot spec
    const detailedSpecs = JSON.parse(document.getElementById('vega_detailed_json').textContent);
    const allMagsSpec = detailedSpecs['all_mags'];
    
    if (!allMagsSpec || !allMagsSpec.plots || !allMagsSpec.plots[selectedMetric]) {
      plotContainer.innerHTML = '<div class="alert alert-warning">No plot available for the selected metric.</div>';
      return;
    }
    
    // Clear existing plot
    plotContainer.innerHTML = '';
    
    // Get the plot spec (make a copy to avoid modifying the original)
    const plotSpec = JSON.parse(JSON.stringify(allMagsSpec.plots[selectedMetric]));
    
    // Vega-Lite will handle responsive width via autosize configured in Python
    // No need to modify the spec - just embed it and let Vega handle resizing
    vegaEmbed(plotContainer, plotSpec, {
      actions: false,
      renderer: 'svg'
    }).then(
      function (result) {
        result.view.logLevel(vega.Warn);
        window.plotView = result.view;
        
        // Vega handles responsive resizing automatically via autosize with resize: true
      }
    ).catch(
      function (error) {
        plotContainer.innerHTML = `
          <div class="alert alert-warning">
            <strong>Error loading plots:</strong> ${error.message}
          </div>
        `;
      }
    );
  }

  $(document).ready(function () {
    // temporary hack to make it look good with Bootstrap 5
    adjustTagsToBS3()

    // Add event listener for metric selector
    const metricSelector = document.getElementById('metricSelector');
    if (metricSelector) {
      metricSelector.addEventListener('change', updatePlot);
    }
    
    // Initial plot render
    updatePlot();
  });
</script>

{% endblock %}

{% block footer %}
<script type="text/javascript">
  // Simple error handler function
  function handleErrors(errors, element) {
    console.error('Vega/Vega-Lite error:', errors);
    if (element && element.length) {
      element.html('<div class="alert alert-danger"><strong>Error:</strong> Failed to render plot. Check console for details.</div>');
    }
  }
</script>
{% endblock %}
