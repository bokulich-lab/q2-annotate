{% extends 'tabbed.html' %}

{% block head %}
<title>BUSCO QC Dashboard</title>
<script src="js/bootstrapMagic.js" type="text/javascript"></script>
<link href="css/styles.css" rel="stylesheet"/>
<script type="text/javascript">
    // temporary hack to make it look good with Bootstrap 5
    removeBS3refs();
</script>
<script src="https://cdn.jsdelivr.net/npm//vega@6" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-lite@6" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm//vega-embed@6" type="text/javascript"></script>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha256-YvdLHPgkqJ8DVUxjjnGVlMMJtNimJ6dYkowFFvp4kKs=" rel="stylesheet"/>
{% endblock %}

{% block tabcontent %}
<script crossorigin="anonymous" integrity="sha256-9SEPo+fwJFpMUet/KACSwO+Z/dKMReF9q4zFhU/fT9M=" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<br>
<div class="row gx-2 mb-2">
    <div class="col-lg-12">
        <div class="card">
            <h5 class="card-header">BUSCO summary statistics</h5>
            <div class="card-body">
                <p>
                    The table below shows the summary statistics of the BUSCO marker count
                    fractions for the categories
                    <b>Single</b>, <b>Duplicated</b>, <b>Fragmented</b>, <b>Missing</b>
                    {% if not comp_cont %}and {% else %}, {% endif %}<b>Complete</b>{% if comp_cont %}, <b>Completeness</b> {% if not unbinned %}and <b>Contamination</b>.{% else %}, <b>Contamination</b>
                    and <b>Unbinned contigs</b>.{% endif %}{% endif %} The statistics are calculated for the categories across <b>all MAGs</b> in <b>all samples</b>{% if unbinned %}, including the
                    percentage of <b>Unbinned contigs</b> per sample{% endif %}.
                </p>
                <table id="summaryTable" class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">% single</th>
                        <th scope="col">% duplicated</th>
                        <th scope="col">% fragmented</th>
                        <th scope="col">% missing</th>
                        <th scope="col">% complete</th>
                        {% if comp_cont %}
                            <th scope="col">% completeness</th>
                            <th scope="col">% contamination</th>
                        {% endif %}
                        {% if unbinned %}
                            <th scope="col">% unbinned contigs</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    <tr id="rowMinimum">
                      <th scope="row">Minimum</th>
                    </tr>
                    <tr id="rowMedian">
                      <th scope="row">Median</th>
                    </tr>
                    <tr id="rowMean">
                      <th scope="row">Mean</th>
                    </tr>
                    <tr id="rowMaximum">
                      <th scope="row">Maximum</th>
                    </tr>
                    <tr id="rowTotal">
                      <th scope="row">Total count</th>
                    </tr>
                </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="row gx-2" style="margin-bottom: 10px">
    <div class="col-lg-12">
        <div class="card">
            <h5 class="card-header">
                Distribution of BUSCO marker gene counts
            </h5>
            <div class="collapse show" id="histogramsCollapse">
                <div class="card-body">
                    <div style="display:flex; align-items:center; gap: 12px; margin-bottom: 8px;">
                        <span class="header-inline">Sample:</span>
                        <select id="globalSampleSelect" class="form-select form-select-sm" style="width:auto">
                            <option value="All" selected>All</option>
                        </select>
                        <span class="header-inline">View:</span>
                        <select id="visualizationToggle" class="form-select form-select-sm" style="width:auto">
                            <option value="histograms">Histograms</option>
                            <option value="boxplots" selected>Box plots</option>
                        </select>
                    </div>
                    <p id="visualizationDescription">
                        The box plots below show distributions of BUSCO marker count fractions and assembly metrics.
                        Each box shows the median, quartiles, and outliers for each category. Individual data points
                        are overlaid with low transparency. Use the sample filter to highlight a specific sample
                        across all box plots.
                    </p>
                    <div class="col-lg-12" id="summaryHistogramsMarkers">
                        <div id="plotMarkers" class="square-chart-grid" style="margin-top: 5px"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row gx-2" style="margin-bottom: 10px">
    {% if comp_cont %}
    <div class="col-lg-6">
        <div class="card h-100">
            <h5 class="card-header">Completeness vs. contamination</h5>
            <div class="card-body" style="display: block;">
                <p>
                    Relationship between BUSCO completeness and contamination for each bin.
                </p>
                <div id="scatterPlotDiv" style="margin-top: 5px; width: 100%;"></div>
            </div>
        </div>
    </div>
    {% endif %}
    <div class="col-lg-6">
        <div class="card h-100">
            <h5 class="card-header">Distribution of unbinned contigs</h5>
            <div class="card-body" style="display: block;">
                {% if unbinned %}
                <p>
                    Distribution of unbinned contigs across all samples.
                </p>
                <div id="plotUnbinned" style="margin-top: 5px; width: 100%;"></div>
                {% else %}
                <div style="display: flex; align-items: center; justify-content: center;">
                    <p style="font-style: italic; margin: 0; color: #6c757d;">No data available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Vega Specs -->
<script id="vega_histogram_spec" type="application/json">
    {{ vega_histogram_spec | safe }}
</script>

<script id="vega_unbinned_spec" type="application/json">
    {{ vega_unbinned_spec | safe }}
</script>

<script id="vega_box_plot_spec" type="application/json">
    {{ vega_box_plot_spec | safe }}
</script>

<script id="vega_scatter_spec" type="application/json">
    {{ vega_scatter_spec | safe }}
</script>

<!-- Data -->
<script id="histogram_data" type="application/json">
    {{ histogram_data | safe }}
</script>

<script id="box_plot_data" type="application/json">
    {{ box_plot_data | safe }}
</script>

<script id="scatter_data" type="application/json">
    {{ scatter_data | safe }}
</script>

<script id="unbinned_data" type="application/json">
    {{ unbinned_data | safe }}
</script>

<script id="sample_ids_json" type="application/json">
    {{ sample_ids_json | safe }}
</script>

<script id="metrics_json" type="application/json">
    {{ metrics_json | safe }}
</script>

<script id="summary_stats_json" type="application/json">
    {{ summary_stats_json | safe }}
</script>

<script type="text/javascript">
    $(document).ready(function () {
        // temporary hack to make it look good with Bootstrap 5
        adjustTagsToBS3()

        const summarySpec = JSON.parse(document.getElementById('summary_stats_json').textContent);

        const rows = ['rowMinimum', 'rowMedian', 'rowMean', 'rowMaximum', 'rowTotal'];
        const cols = ['single', 'duplicated', 'fragmented', 'missing', 'complete', 'completeness', 'contamination', 'unbinned_contigs'];
        rows.forEach((rowId, index) => {
            let rowElement = document.getElementById(rowId)
            let colVals = summarySpec.data[index]
            cols.forEach((col) => {
                let td = document.createElement('td');
                td.textContent = colVals[col];
                rowElement.appendChild(td);
            })
        })

        // Populate sample dropdown from server-provided list
        const selectEl = document.getElementById('globalSampleSelect');
        try {
            const ids = JSON.parse(document.getElementById('sample_ids_json').textContent || '[]');
            ids.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id; opt.textContent = id; selectEl.appendChild(opt);
            });
        } catch (e) {}

        // Load specs and data
        const histogramSpec = JSON.parse(document.getElementById('vega_histogram_spec').textContent);
        const boxPlotSpec = JSON.parse(document.getElementById('vega_box_plot_spec').textContent);
        const histogramData = JSON.parse(document.getElementById('histogram_data').textContent);
        const boxPlotData = JSON.parse(document.getElementById('box_plot_data').textContent);
        const metrics = JSON.parse(document.getElementById('metrics_json').textContent);

        const grid = document.getElementById('plotMarkers');
        const visualizationToggle = document.getElementById('visualizationToggle');
        const descriptionEl = document.getElementById('visualizationDescription');

        // Track views for coordinated filtering
        const views = [];
        let currentViews = [];

        const actionsCfg = {actions: false};

        // Metric titles for display
        const metricTitles = {
            'single': 'Single',
            'duplicated': 'Duplicated',
            'fragmented': 'Fragmented',
            'missing': 'Missing',
            'completeness': 'Completeness',
            'contamination': 'Contamination',
            'contigs_n50': 'Contig N50',
            'length': 'Length'
        };

        // Y-axis formats by metric type
        const yFormats = {
            'single': '.0f',
            'duplicated': '.0f',
            'fragmented': '.0f',
            'missing': '.0f',
            'completeness': '.0f',
            'contamination': '.0f',
            'contigs_n50': '.2s',
            'length': '.2s'
        };

        // Function to clear current plots
        function clearPlots() {
            grid.innerHTML = '';
            currentViews.forEach(view => {
                const index = views.indexOf(view);
                if (index > -1) {
                    views.splice(index, 1);
                }
            });
            currentViews = [];
        }

        // Function to render histograms
        function renderHistograms() {
            clearPlots();
            grid.className = 'square-chart-grid';
            
            metrics.forEach((metric) => {
                const div = document.createElement('div');
                grid.appendChild(div);
                
                // Clone spec and set metric parameter
                const spec = JSON.parse(JSON.stringify(histogramSpec));
                spec.data = { values: histogramData };
                spec.params[1].value = metric;
                spec.encoding.x.title = metricTitles[metric] || metric;
                
                vegaEmbed(div, spec, actionsCfg).then(
                    function (result) {
                        result.view.logLevel(vega.Warn);
                        result.view.resize();
                        views.push(result.view);
                        currentViews.push(result.view);
                    }
                ).catch(
                    function (error) {
                        handleErrors([error], $(div));
                    }
                );
            });
        }

        // Function to render box plots
        function renderBoxPlots() {
            clearPlots();
            grid.className = 'chart-grid';
            
            metrics.forEach((metric) => {
                if (!boxPlotData[metric]) return;
                
                const div = document.createElement('div');
                grid.appendChild(div);
                
                // Clone spec and set data + metric
                const spec = JSON.parse(JSON.stringify(boxPlotSpec));
                spec.data = { values: boxPlotData[metric] };
                spec.params[1].value = metric;
                spec.params[2].value = yFormats[metric] || '.2f';
                
                // Update y-axis title in layer encodings
                if (spec.layer) {
                    spec.layer.forEach(layer => {
                        if (layer.encoding && layer.encoding.y) {
                            layer.encoding.y.title = metricTitles[metric] || metric;
                        }
                    });
                }
                
                vegaEmbed(div, spec, actionsCfg).then(
                    function (result) {
                        result.view.logLevel(vega.Warn);
                        result.view.resize();
                        views.push(result.view);
                        currentViews.push(result.view);
                    }
                ).catch(
                    function (error) {
                        handleErrors([error], $(div));
                    }
                );
            });
        }

        // Function to update description
        function updateDescription(type) {
            if (type === 'histograms') {
                descriptionEl.textContent = 'The histograms below show distributions of BUSCO marker count fractions and assembly metrics. Use the sample filter to show all samples or a single sample. Switch between histograms and box plots using the view toggle.';
            } else {
                descriptionEl.textContent = 'The box plots below show distributions of BUSCO marker count fractions and assembly metrics. Each box shows the median, quartiles, and outliers for each category. Individual data points are overlaid with low transparency. Use the sample filter to highlight a specific sample across all box plots.';
            }
        }

        // Toggle event listener
        visualizationToggle.addEventListener('change', function() {
            const selectedType = this.value;
            updateDescription(selectedType);
            
            if (selectedType === 'histograms') {
                renderHistograms();
            } else {
                renderBoxPlots();
            }
        });

        // Initial render (box plots by default)
        renderBoxPlots();

        // Embed scatter plot
        {% if comp_cont %}
        const scatterSpec = JSON.parse(document.getElementById('vega_scatter_spec').textContent);
        const scatterData = JSON.parse(document.getElementById('scatter_data').textContent);
        scatterSpec.data = { values: scatterData };
        scatterSpec.params[1].value = {{ upper_x }};
        scatterSpec.params[2].value = {{ upper_y }};
        
        vegaEmbed("#scatterPlotDiv", scatterSpec, actionsCfg).then(
            function (result) {
                result.view.logLevel(vega.Warn);
                result.view.resize();
                views.push(result.view);
            }
        ).catch(
            function (error) {
                handleErrors([error], $("#scatterPlotDiv"));
            }
        );
        {% endif %}

        // Embed unbinned plot
        {% if unbinned %}
        let unbinnedSpec = JSON.parse(document.getElementById('vega_unbinned_spec').textContent);
        console.log(unbinnedSpec);
        const unbinnedData = JSON.parse(document.getElementById('unbinned_data').textContent);
        unbinnedSpec = JSON.parse(JSON.stringify(unbinnedSpec));
        unbinnedSpec.data = { values: unbinnedData.map(d => ({...d, metric: d.unbinned_contigs_count, category: 'unbinned_contigs_count'})) };
        unbinnedSpec.params[1].value = 'unbinned_contigs_count';
        unbinnedSpec.encoding.x.title = 'Unbinned contig count';
        unbinnedSpec.encoding.y.title = 'Sample count';
        
        vegaEmbed("#plotUnbinned", unbinnedSpec, actionsCfg).then(
            function (result) {
                result.view.logLevel(vega.Warn);
                result.view.resize();
            }
        ).catch(
            function (error) {
                handleErrors([error], $("#plotUnbinned"));
            }
        );
        {% endif %}

        function updateViewsSelectedId(value) {
            views.forEach(v => {
                try { v.signal('selected_id', value).run(); } catch (e) {}
            });
        }

        selectEl.addEventListener('change', (e) => {
            const value = e.target.value || 'All';
            updateViewsSelectedId(value);
        });

        // Initialize with 'All'
        updateViewsSelectedId('All');

        // Handle collapse chevron rotation
        const collapseElement = document.getElementById('histogramsCollapse');
        const chevronIcon = document.querySelector('[data-bs-target="#histogramsCollapse"] i');
        
        if (collapseElement && chevronIcon) {
            collapseElement.addEventListener('show.bs.collapse', function () {
                chevronIcon.classList.remove('fa-chevron-right');
                chevronIcon.classList.add('fa-chevron-down');
            });
            
            collapseElement.addEventListener('hide.bs.collapse', function () {
                chevronIcon.classList.remove('fa-chevron-down');
                chevronIcon.classList.add('fa-chevron-right');
            });
        }
    });
</script>

{% endblock %}

{% block footer %}
{% set loading_selector = '#loading' %}
{% include 'js-error-handler.html' %}
{% endblock %}
